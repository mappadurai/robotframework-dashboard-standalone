name: Auto Sync Fork with Upstream

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream remote and fetch
      run: |
        git remote add upstream https://github.com/timdegroot1996/robotframework-dashboard.git || true
        git fetch upstream main

    - name: Check and sync with upstream
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        UPSTREAM_HASH=$(git rev-parse upstream/main)
        CURRENT_HASH=$(git rev-parse HEAD)

        echo "Current HEAD: $CURRENT_HASH"
        echo "Upstream HEAD: $UPSTREAM_HASH"

        if [ "$UPSTREAM_HASH" = "$CURRENT_HASH" ]; then
          echo "‚úÖ Fork is already up to date with upstream"
          exit 0
        fi

        COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main)
        COMMITS_AHEAD=$(git rev-list --count upstream/main..HEAD)

        echo "üìä Status: $COMMITS_BEHIND commits behind, $COMMITS_AHEAD commits ahead"

        if [ "$COMMITS_BEHIND" -eq 0 ]; then
          echo "‚úÖ Fork is up to date or ahead of upstream - no sync needed"
          exit 0
        fi

        # Get list of new commits for logging
        echo "üìù New commits from upstream:"
        git log --oneline HEAD..upstream/main

        # Create a unique sync branch
        SYNC_BRANCH="sync-upstream-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$SYNC_BRANCH"

        # Try to merge upstream changes
        echo "üîÑ Attempting to merge upstream changes..."
        if git merge upstream/main --no-edit; then
          echo "‚úÖ Successfully merged upstream changes without conflicts"

          # Push the branch
          git push origin "$SYNC_BRANCH"

          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$SYNC_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            # Save new commits to a temp file
            git log --oneline HEAD~${COMMITS_BEHIND}..HEAD > /tmp/new_commits.txt

            # Create PR using a file for the body
            cat > /tmp/pr_body.md << 'EOFBODY'
## üîÑ Automated Upstream Sync

This PR automatically syncs new commits from the upstream repository.

### üìä Summary
EOFBODY
            echo "- **Commits behind:** $COMMITS_BEHIND" >> /tmp/pr_body.md
            echo "- **Your commits ahead:** $COMMITS_AHEAD" >> /tmp/pr_body.md
            cat >> /tmp/pr_body.md << 'EOFBODY'
- **Upstream repository:** https://github.com/timdegroot1996/robotframework-dashboard

### üìù New commits from upstream:
```
EOFBODY
            cat /tmp/new_commits.txt >> /tmp/pr_body.md
            cat >> /tmp/pr_body.md << 'EOFBODY'
```

### ‚úÖ Merge Status
No conflicts detected! This PR can be merged safely.

---
*This PR was automatically created by the upstream sync workflow*
EOFBODY

            gh pr create \
              --title "üîÑ Sync upstream changes (${COMMITS_BEHIND} commits)" \
              --body-file /tmp/pr_body.md \
              --base main \
              --head "$SYNC_BRANCH" \
              --label "upstream-sync"

            echo "üéâ Successfully created PR for syncing $COMMITS_BEHIND commits from upstream!"
          else
            echo "‚ÑπÔ∏è PR already exists: #$EXISTING_PR"
          fi
        else
          echo "‚ö†Ô∏è Merge conflicts detected"

          # Get conflicted files
          CONFLICTED_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "Unable to list conflicted files")

          echo "Conflicted files:"
          echo "$CONFLICTED_FILES"

          # Abort the merge to get back to clean state
          git merge --abort

          # Reset to main and push the branch
          git checkout main
          git checkout -b "$SYNC_BRANCH"
          git push origin "$SYNC_BRANCH"

          # Save upstream commits to a temp file
          git log --oneline HEAD..upstream/main > /tmp/upstream_commits.txt

          # Create PR body for conflicts
          cat > /tmp/pr_body_conflict.md << 'EOFBODY'
## ‚ö†Ô∏è Automated Upstream Sync - Conflicts Detected

This PR attempts to sync new commits from the upstream repository, but merge conflicts were detected.

### üìä Summary
EOFBODY
          echo "- **Commits behind:** $COMMITS_BEHIND" >> /tmp/pr_body_conflict.md
          echo "- **Your commits ahead:** $COMMITS_AHEAD" >> /tmp/pr_body_conflict.md
          cat >> /tmp/pr_body_conflict.md << 'EOFBODY'
- **Upstream repository:** https://github.com/timdegroot1996/robotframework-dashboard

### üî¥ Files with Conflicts
```
EOFBODY
          echo "$CONFLICTED_FILES" >> /tmp/pr_body_conflict.md
          cat >> /tmp/pr_body_conflict.md << 'EOFBODY'
```

### üìù New commits from upstream:
```
EOFBODY
          cat /tmp/upstream_commits.txt >> /tmp/pr_body_conflict.md
          cat >> /tmp/pr_body_conflict.md << 'EOFBODY'
```

### üîß How to Resolve

**Option 1: Resolve locally (Recommended)**
```bash
# Fetch and checkout this branch
git fetch origin
EOFBODY
          echo "git checkout $SYNC_BRANCH" >> /tmp/pr_body_conflict.md
          cat >> /tmp/pr_body_conflict.md << 'EOFBODY'

# Merge upstream and resolve conflicts
git merge upstream/main

# After resolving conflicts in your editor:
git add .
git commit -m "Resolve merge conflicts with upstream"
EOFBODY
          echo "git push origin $SYNC_BRANCH" >> /tmp/pr_body_conflict.md
          cat >> /tmp/pr_body_conflict.md << 'EOFBODY'

# The PR will update automatically
```

**Option 2: Manual merge from scratch**
```bash
git checkout main
git pull origin main
git remote add upstream https://github.com/timdegroot1996/robotframework-dashboard.git || true
git fetch upstream
git merge upstream/main
# Resolve conflicts, then commit and push
```

---
*This PR was automatically created by the upstream sync workflow*
EOFBODY

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$SYNC_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            # Create PR with conflict warning
            gh pr create \
              --title "‚ö†Ô∏è Sync upstream changes (${COMMITS_BEHIND} commits) - Conflicts Detected" \
              --body-file /tmp/pr_body_conflict.md \
              --base main \
              --head "$SYNC_BRANCH" \
              --label "upstream-sync,conflicts"

            echo "‚ö†Ô∏è Created PR with conflict information. Manual resolution required."
            echo "::warning::Upstream sync has conflicts. Please review the PR and resolve conflicts."
          else
            echo "‚ÑπÔ∏è PR already exists: #$EXISTING_PR"
          fi
        fi
