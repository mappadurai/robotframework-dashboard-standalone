name: Auto Sync Fork with Upstream

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream remote and fetch
      run: |
        git remote add upstream https://github.com/timdegroot1996/robotframework-dashboard.git || true
        git fetch upstream main

    - name: Check and sync with upstream
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        UPSTREAM_HASH=$(git rev-parse upstream/main)
        CURRENT_HASH=$(git rev-parse HEAD)

        echo "Current HEAD: $CURRENT_HASH"
        echo "Upstream HEAD: $UPSTREAM_HASH"

        if [ "$UPSTREAM_HASH" = "$CURRENT_HASH" ]; then
          echo "‚úÖ Fork is already up to date with upstream"
          exit 0
        fi

        COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main)
        COMMITS_AHEAD=$(git rev-list --count upstream/main..HEAD)

        echo "üìä Status: $COMMITS_BEHIND commits behind, $COMMITS_AHEAD commits ahead"

        if [ "$COMMITS_BEHIND" -eq 0 ]; then
          echo "‚úÖ Fork is up to date or ahead of upstream - no sync needed"
          exit 0
        fi

        echo "üìù New commits from upstream:"
        git log --oneline HEAD..upstream/main

        SYNC_BRANCH="sync-upstream-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$SYNC_BRANCH"

        echo "üîÑ Attempting to merge upstream changes..."
        if git merge upstream/main --no-edit; then
          echo "‚úÖ Successfully merged upstream changes without conflicts"
          git push origin "$SYNC_BRANCH"

          EXISTING_PR=$(gh pr list --head "$SYNC_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            git log --oneline HEAD~${COMMITS_BEHIND}..HEAD > /tmp/commits.txt

            {
              echo "## üîÑ Automated Upstream Sync"
              echo ""
              echo "This PR automatically syncs new commits from the upstream repository."
              echo ""
              echo "### üìä Summary"
              echo "- **Commits behind:** $COMMITS_BEHIND"
              echo "- **Your commits ahead:** $COMMITS_AHEAD"
              echo "- **Upstream repository:** https://github.com/timdegroot1996/robotframework-dashboard"
              echo ""
              echo "### üìù New commits from upstream:"
              echo "\`\`\`"
              cat /tmp/commits.txt
              echo "\`\`\`"
              echo ""
              echo "### ‚úÖ Merge Status"
              echo "No conflicts detected! This PR can be merged safely."
            } > /tmp/pr_body.md

            gh pr create \
              --title "üîÑ Sync upstream changes (${COMMITS_BEHIND} commits)" \
              --body-file /tmp/pr_body.md \
              --base main \
              --head "$SYNC_BRANCH" \
              --label "upstream-sync"

            echo "üéâ Successfully created PR for syncing $COMMITS_BEHIND commits from upstream!"
          else
            echo "‚ÑπÔ∏è PR already exists: #$EXISTING_PR"
          fi
        else
          echo "‚ö†Ô∏è Merge conflicts detected"

          CONFLICTED_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "Unable to list files")
          echo "Conflicted files: $CONFLICTED_FILES"

          git merge --abort
          git checkout main
          git checkout -b "$SYNC_BRANCH"
          git push origin "$SYNC_BRANCH"

          git log --oneline HEAD..upstream/main > /tmp/upstream_commits.txt

          {
            echo "## ‚ö†Ô∏è Automated Upstream Sync - Conflicts Detected"
            echo ""
            echo "This PR attempts to sync new commits from the upstream repository, but merge conflicts were detected."
            echo ""
            echo "### üìä Summary"
            echo "- **Commits behind:** $COMMITS_BEHIND"
            echo "- **Your commits ahead:** $COMMITS_AHEAD"
            echo "- **Upstream repository:** https://github.com/timdegroot1996/robotframework-dashboard"
            echo ""
            echo "### üî¥ Files with Conflicts"
            echo "\`\`\`"
            echo "$CONFLICTED_FILES"
            echo "\`\`\`"
            echo ""
            echo "### üìù New commits from upstream:"
            echo "\`\`\`"
            cat /tmp/upstream_commits.txt
            echo "\`\`\`"
            echo ""
            echo "### üîß How to Resolve"
            echo ""
            echo "**Option 1: Resolve locally (Recommended)**"
            echo "\`\`\`bash"
            echo "git fetch origin"
            echo "git checkout $SYNC_BRANCH"
            echo "git merge upstream/main"
            echo "# Resolve conflicts in your editor, then:"
            echo "git add ."
            echo "git commit -m \"Resolve merge conflicts with upstream\""
            echo "git push origin $SYNC_BRANCH"
            echo "\`\`\`"
            echo ""
            echo "**Option 2: Manual merge from scratch**"
            echo "\`\`\`bash"
            echo "git checkout main"
            echo "git pull origin main"
            echo "git remote add upstream https://github.com/timdegroot1996/robotframework-dashboard.git || true"
            echo "git fetch upstream"
            echo "git merge upstream/main"
            echo "# Resolve conflicts, then commit and push"
            echo "\`\`\`"
          } > /tmp/pr_body_conflict.md

          EXISTING_PR=$(gh pr list --head "$SYNC_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "‚ö†Ô∏è Sync upstream changes (${COMMITS_BEHIND} commits) - Conflicts Detected" \
              --body-file /tmp/pr_body_conflict.md \
              --base main \
              --head "$SYNC_BRANCH" \
              --label "upstream-sync,conflicts"

            echo "‚ö†Ô∏è Created PR with conflict information. Manual resolution required."
            echo "::warning::Upstream sync has conflicts. Please review the PR and resolve conflicts."
          else
            echo "‚ÑπÔ∏è PR already exists: #$EXISTING_PR"
          fi
        fi
